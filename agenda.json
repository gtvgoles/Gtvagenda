<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karaoke PRO</title>

<style>
body{
  margin:0;
  background:#0b1020;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  color:white;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:15px;
}
.card{
  background:rgba(255,255,255,0.05);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
}
textarea,input,button{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  margin-top:8px;
  font-size:16px;
}
button{
  font-weight:bold;
  cursor:pointer;
}
.primary{background:#22c55e;color:black;}
.secondary{background:#3b82f6;}
.warn{background:#f59e0b;color:black;}
canvas{
  width:100%;
  background:black;
  border-radius:18px;
}
.phrase{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.active{
  background:rgba(255,255,255,0.1);
}
.time{
  font-size:12px;
  opacity:0.7;
}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h2>Pegar letra completa</h2>
<textarea id="lyricsInput" placeholder="Pega toda la letra aquí..."></textarea>
<button class="primary" onclick="splitLyrics()">Separar automáticamente</button>
</div>

<div class="card">
<h2>Audio y diseño</h2>
<input type="file" id="audioFile" accept="audio/*">
<input type="file" id="bgFile" accept="image/*">
<input type="file" id="coverFile" accept="image/*">
</div>

<div class="card">
<h2>Sincronización</h2>
<button class="secondary" onclick="markStart()">Marcar inicio</button>
<button class="secondary" onclick="markEnd()">Marcar fin</button>
<button onclick="prevPhrase()">← Frase anterior</button>
<button onclick="nextPhrase()">Frase siguiente →</button>
</div>

<div class="card">
<h2>Frases</h2>
<div id="phrases"></div>
</div>

<div class="card">
<h2>Vista previa</h2>
<canvas id="canvas" width="1920" height="1080"></canvas>
</div>

<div class="card">
<button class="primary" onclick="exportProject()">Exportar proyecto (.karaoke)</button>
<button class="warn" onclick="importProject()">Importar proyecto</button>
<button class="primary" onclick="renderMP4()">Descargar MP4 1080p (PC)</button>
</div>

</div>

<script>
let audio=null;
let bg=null;
let cover=null;
let phrases=[];
let currentIndex=0;

const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

function autoSave(){
  localStorage.setItem("karaokePro",JSON.stringify({phrases,currentIndex}));
}
setInterval(autoSave,5000);

function splitLyrics(){
  const text=document.getElementById("lyricsInput").value.trim();
  phrases=text
    .replace(/\r/g,"")
    .split(/\n+|(?<=[.!?])\s+/)
    .filter(t=>t.trim().length>0)
    .map(t=>({text:t.trim(),start:null,end:null}));
  currentIndex=0;
  renderPhrases();
}

function renderPhrases(){
  const container=document.getElementById("phrases");
  container.innerHTML="";
  phrases.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="phrase"+(i===currentIndex?" active":"");
    div.innerHTML=`
      ${p.text}
      <div class="time">${p.start||"--"} - ${p.end||"--"}</div>
    `;
    container.appendChild(div);
  });
}

function markStart(){
  if(!audio)return;
  phrases[currentIndex].start=parseFloat(audio.currentTime.toFixed(2));
  renderPhrases();
}

function markEnd(){
  if(!audio)return;
  phrases[currentIndex].end=parseFloat(audio.currentTime.toFixed(2));
  nextPhrase();
  renderPhrases();
}

function nextPhrase(){
  if(currentIndex<phrases.length-1)currentIndex++;
  renderPhrases();
}

function prevPhrase(){
  if(currentIndex>0)currentIndex--;
  renderPhrases();
}

document.getElementById("audioFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  audio=new Audio(URL.createObjectURL(file));
  audio.play();
});

document.getElementById("bgFile").addEventListener("change",async e=>{
  const file=e.target.files[0];
  bg=await createImageBitmap(file);
});

document.getElementById("coverFile").addEventListener("change",async e=>{
  const file=e.target.files[0];
  cover=await createImageBitmap(file);
});

function drawFrame(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,1920,1080);

  if(bg){
    ctx.drawImage(bg,0,0,1920,1080);
  }

  if(cover){
    ctx.drawImage(cover,150,300,400,400);
  }

  let current=phrases.find(p=>
    p.start!=null &&
    p.end!=null &&
    audio &&
    audio.currentTime>=p.start &&
    audio.currentTime<=p.end
  );

  if(current){
    ctx.font="bold 70px Arial";
    ctx.fillStyle="white";
    ctx.fillText(current.text,900,540);
  }

  requestAnimationFrame(drawFrame);
}

drawFrame();

function exportProject(){
  const blob=new Blob([JSON.stringify({phrases})],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="karaoke.karaoke";
  a.click();
}

function importProject(){
  const input=document.createElement("input");
  input.type="file";
  input.accept=".karaoke,.json";
  input.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=()=>{
      const data=JSON.parse(reader.result);
      phrases=data.phrases||[];
      renderPhrases();
    };
    reader.readAsText(file);
  };
  input.click();
}

function renderMP4(){
  if(/Android|iPhone/i.test(navigator.userAgent)){
    alert("Para descargar MP4 usa PC.");
    return;
  }
  alert("Aquí se integraría FFmpeg WASM para exportar 1080p (versión PC).");
}
</script>

</body>
</html>